name: "CI"

env:
  API_KEY_ALCHEMY: ${{ secrets.API_KEY_ALCHEMY }}
  FOUNDRY_PROFILE: "ci"

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - "main"

jobs:
  build:
    runs-on: "ubuntu-latest"
    steps:
      - name: "Check out the repo"
        uses: "actions/checkout@v4"

      - name: "Install Foundry"
        uses: "foundry-rs/foundry-toolchain@v1"

      - name: "Install Bun"
        uses: "oven-sh/setup-bun@v1"

      - name: "Install the Node.js dependencies"
        run: "bun install"

      - name: "Build the contracts and print their size"
        run: "forge build --sizes"

      - name: "Add build summary"
        run: |
          echo "## Build result" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Passed" >> $GITHUB_STEP_SUMMARY

  test:
    needs: ["build"]
    runs-on: "ubuntu-latest"
    steps:
       - uses: actions/checkout@v2

       - name: Run unit tests with coverage
         run: |
           SUMMARY="$(npm test -- --coverage --coverageReporters=text-summary | tail -3 | head -1)"
           TOKENS=($SUMMARY)
            echo "COVERAGE=$(echo ${TOKENS[2]})" >> $GITHUB_ENV

            # var REF = 'refs/pull/27/merge.json';
            REF=${{ github.ref }}
            # console.log('github.ref: ' + REF);
            echo "github.ref: $REF"
            # var PATHS = REF.split('/');
            IFS='/' read -ra PATHS <<< "$REF"
            # var BRANCH_NAME = PATHS[1] + '_' + PATHS[2];
            BRANCH_NAME="${PATHS[1]}_${PATHS[2]}"
            # console.log(BRANCH_NAME); // 'pull_27'
            echo $BRANCH_NAME
            # process.env.BRANCH = 'pull_27';
            echo "BRANCH=$(echo ${BRANCH_NAME})" >> $GITHUB_ENV
       - name: Create Coverage Badge
         uses: schneegans/dynamic-badges-action@v1.1.0
         with:
           auth: ${{ secrets.GIST_SECRET }}
           gistID: c58317c4d6983cacf14e0466cb1d2438
           filename: Decentralised-Saas-Investment-Protocol_coverage.json
           label: coverage
           message: ${{ env.COVERAGE }}
           namedLogo: jest
           color: blue
           logoColor: lightblue
